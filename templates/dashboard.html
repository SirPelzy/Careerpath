{% extends "base.html" %}

{% block title %}Your Dashboard - Careerpath!{% endblock %}

{% block content %}
  {# --- Welcome Header --- #}
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Welcome, {{ current_user.first_name }}!</h1>
    {# Optional: Add profile/settings buttons #}
  </div>

  {# --- Check if a Path is Selected --- #}
  {% if path %}

    {# --- Summary Dashboard Section --- #}
    <div class="row mb-4">
      <div class="col-md-12">
        <h4>Overall Journey Progress</h4>
      </div>
      <div class="col-md-8 mb-3 mb-md-0">
        {# --- ID added to container for easier title update --- #}
        <div id="overall-progress-bar-container" class="progress" style="height: 25px;" title="{{ overall_percent_complete }}% Complete">
           {# --- ID added to bar for updates --- #}
          <div id="overall-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated {% if overall_percent_complete == 100 %}bg-success{% else %}bg-primary{% endif %}" role="progressbar" style="width: {{ overall_percent_complete }}%;" aria-valuenow="{{ overall_percent_complete }}" aria-valuemin="0" aria-valuemax="100">{{ overall_percent_complete }}%</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center h-100">
          <div class="card-body py-2">
              {# --- ID added to text for updates --- #}
              <p id="overall-progress-text" class="card-text mb-0">
                  <strong class="fs-5">{{ total_completed_steps }}</strong> / {{ total_steps_in_path }} Steps Completed
              </p>
              {# --- ID added to timeline text for potential future updates --- #}
              <small id="timeline-estimate-text" class="text-muted d-block">{{ timeline_estimate }}</small>
          </div>
        </div>
      </div>
    </div>
    <hr>
    {# --- End Summary Dashboard Section --- #}

    {# --- Path Milestones Section --- #}
    <h2 class="h4">{{ path.name }} Journey Milestones</h2>

    <div class="accordion" id="milestonesAccordion">
      {% if milestones %}
        {% for milestone in milestones %}
          <div class="accordion-item">
            {# --- ID added to header for potential targeting --- #}
            <h2 class="accordion-header" id="heading{{ milestone.id }}">
              {% set progress = milestone_progress.get(milestone.id) %}
              {# --- Added conditional class to button based on completion --- #}
              <button class="accordion-button collapsed {% if progress and progress.percent == 100 and progress.total > 0 %}bg-success-subtle text-success{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ milestone.id }}" aria-expanded="false" aria-controls="collapse{{ milestone.id }}">
                <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                  <span>Milestone {{ loop.index }}: {{ milestone.name }}</span>
                  {# --- Milestone Progress Display (with ID) --- #}
                  {% if progress and progress.total > 0 %}
                    {% if progress.completed == progress.total %}
                      <span id="milestone-{{ milestone.id }}-progress-text" class="badge bg-success ms-2">
                        <i class="bi bi-check-circle-fill me-1"></i>Completed
                      </span>
                    {% else %}
                      <span id="milestone-{{ milestone.id }}-progress-text" class="badge bg-light text-dark ms-2">
                        {{ progress.completed }} / {{ progress.total }} Done ({{ progress.percent }}%)
                      </span>
                    {% endif %}
                  {% elif progress %} {# Case where total steps is 0 #}
                     <span id="milestone-{{ milestone.id }}-progress-text" class="badge bg-light text-dark ms-2">0 / 0 Done</span>
                  {% endif %}
                  {# --- End Milestone Progress Display --- #}
                </div>
              </button>
            </h2>
            <div id="collapse{{ milestone.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ milestone.id }}" data-bs-parent="#milestonesAccordion">
              <div class="accordion-body">
                {# --- Milestone Progress Bar (with IDs) --- #}
                {% set progress = milestone_progress.get(milestone.id) %}
                {% if progress and progress.total > 0 %}
                  <div id="milestone-{{ milestone.id }}-progress-bar-container" class="progress mb-3" style="height: 8px;" title="{{ progress.percent }}% Complete">
                    <div id="milestone-{{ milestone.id }}-progress-bar" class="progress-bar {% if progress.percent == 100 %}bg-success{% else %}bg-primary{% endif %}" role="progressbar" style="width: {{ progress.percent }}%;" aria-valuenow="{{ progress.percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                {% endif %}
                {# --- End Progress Bar --- #}

                {% if milestone.description %}
                  <p>{{ milestone.description }}</p>
                {% endif %}

                {# Steps List #}
                <ul class="list-group">
                  {% for step in milestone.steps %} {# Access steps via relationship #}
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                      {# Step Details #
